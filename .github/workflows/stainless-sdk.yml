name: Build Stainless SDKs

on:
  push:
    branches: [main]
    paths:
      - 'app/api/e2/**'
  workflow_dispatch:
    inputs:
      skip_wait:
        description: 'Skip deployment wait (for local testing)'
        type: boolean
        default: false

concurrency:
  group: stainless-sdk-${{ github.ref }}
  cancel-in-progress: true

env:
  STAINLESS_PROJECT: inbound
  API_BASE_URL: https://inbound.new
  MINTLIFY_PROJECT_ID: 684319e452e43891b702c525
  MINTLIFY_API_KEY: ${{ secrets.MINTLIFY_API_KEY }}

jobs:
  build-sdk:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for Vercel deployment to propagate
        if: ${{ github.event.inputs.skip_wait != 'true' }}
        run: |
          echo "Waiting for Vercel deployment to complete..."
          sleep 180
          
          echo "Checking if API is available..."
          for i in {1..30}; do
            if curl -sSf "${{ env.API_BASE_URL }}/api/e2/openapi.json" > /dev/null 2>&1; then
              echo "API is available!"
              break
            fi
            echo "Attempt $i: API not ready, waiting 10s..."
            sleep 10
          done

      - name: Fetch OpenAPI spec from live API
        run: |
          echo "Fetching OpenAPI spec from ${{ env.API_BASE_URL }}/openapi.json"
          curl -sSf -o openapi.json "${{ env.API_BASE_URL }}/openapi.json"
          echo "OpenAPI spec fetched successfully"
          
          echo "=== Spec Summary ==="
          jq '{title: .info.title, version: .info.version, paths: (.paths | keys | length)}' openapi.json

      - name: Upload to Stainless
        uses: stainless-api/upload-openapi-spec-action/build@v1
        with:
          stainless_api_key: ${{ secrets.STAINLESS_API_KEY }}
          project: ${{ env.STAINLESS_PROJECT }}
          oas_path: openapi.json

      - name: Wait for Stainless to process
        run: |
          echo "Waiting for Stainless to generate SDK code samples..."
          sleep 120

      - name: Trigger Mintlify documentation update
        run: |
          echo "Triggering Mintlify documentation update..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.mintlify.com/v1/project/update/${{ env.MINTLIFY_PROJECT_ID }}" \
            -H "Authorization: Bearer ${{ secrets.MINTLIFY_API_KEY }}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response: $body"
          echo "HTTP Status: $http_code"
          
          if [ "$http_code" = "202" ]; then
            echo "✅ Mintlify update triggered successfully"
            status_id=$(echo "$body" | jq -r '.statusId // empty')
            if [ -n "$status_id" ]; then
              echo "Status ID: $status_id"
            fi
          else
            echo "⚠️ Failed to trigger Mintlify update (HTTP $http_code)"
            echo "This is non-blocking - docs will update on next push to docs branch"
          fi
