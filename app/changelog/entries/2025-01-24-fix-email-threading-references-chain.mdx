---
title: Fix Email Threading - Proper References Header Chain
date: 2025-01-24
version: 2.1.3
summary: Fixed broken email threading when external systems reply to sent emails by implementing RFC 5322 compliant References header construction
---

## Overview
Fixed a critical issue where external replies to emails sent through the API would create new threads instead of attaching to existing conversations. The problem was caused by incorrect References header construction in outbound emails.

## What Changed
- **Enhanced References Chain Building**: Implemented proper RFC 5322 compliant References header construction
- **Fixed Thread Continuity**: External replies now correctly attach to existing threads
- **Improved Threading Headers**: Both database storage and SES email headers now use complete Message-ID chains

## Technical Details

### Root Cause
The reply API endpoint was incorrectly setting the References header to only include the immediate parent Message-ID:

```typescript
// ❌ BROKEN
References: threadingId  // Only immediate parent
```

### Solution
Now builds the complete conversation chain:

```typescript  
// ✅ FIXED
// Parse existing references from original email
let references = [];
if (original.references) {
  references = JSON.parse(original.references)
    .map(ref => formatMessageId(ref));
}

// Add original Message-ID to chain
if (original.messageId && !references.includes(formattedId)) {
  references.push(formattedId);
}

References: references.join(' ')  // Full chain
```

### Flow Impact
**Reproduction Scenario:**
1. Email received → New thread created ✅
2. Send reply using thread ID → Reply added to thread ✅  
3. Reply shows inline in thread list ✅
4. **External reply to sent email → NOW ATTACHES TO EXISTING THREAD ✅** (Previously created new thread ❌)

## Files Modified
- `app/api/v2/emails/[id]/reply/route.ts` - Fixed References header construction

## Impact
- **Backward Compatible**: No breaking changes to API
- **Improved User Experience**: Conversations now stay properly threaded
- **RFC Compliance**: Email headers now follow proper standards
- **External Compatibility**: Works correctly with all major email clients

## Migration Guide
No action required - the fix is automatically applied to all new replies. Existing threads are unaffected and will continue to work normally.