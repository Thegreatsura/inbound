# How to Apply the Email Threading Fix

## Quick Start

Run these commands in order:

```bash
# 1. Regenerate the Drizzle schema from lib/db/schema.ts
bun drizzle-kit generate

# 2. Apply the migration to your database
bun drizzle-kit push
```

That's it! The fix is now applied.

## What These Commands Do

### `bun drizzle-kit generate`
- Reads `lib/db/schema.ts` 
- Auto-generates `drizzle/schema.ts` (TypeScript types)
- Creates migration SQL files in `drizzle/` directory
- ✅ This adds the `sesMessageId` field to the generated schema

### `bun drizzle-kit push`
- Executes migration SQL against your database
- Adds the `ses_message_id` column to the `sent_emails` table
- Creates the index for faster lookups

## Automatic Deployment

The `package.json` `prebuild` script automatically runs:
```json
"prebuild": "drizzle-kit generate && drizzle-kit push"
```

So when you deploy to Vercel, the migration will run automatically.

## Verification

After running the commands, verify the schema was generated:

```bash
# Check that sesMessageId appears in drizzle/schema.ts
grep "sesMessageId" drizzle/schema.ts
```

Expected output:
```
sesMessageId: varchar("ses_message_id", { length: 300 }),
index("sent_emails_ses_message_id_idx").using("btree", table.sesMessageId...
```

## Files Modified

- ✅ `lib/db/schema.ts` - Added `sesMessageId` column definition
- ✅ `drizzle/0050_add_ses_message_id_to_sent_emails.sql` - Migration SQL
- ✅ `app/api/v2/emails/[id]/reply/route.ts` - Stores SES Message-ID
- ✅ `lib/email-management/email-threader.ts` - Checks sesMessageId for threading

**DO NOT manually edit:**
- ❌ `drizzle/schema.ts` - Auto-generated by `drizzle-kit generate`

## Troubleshooting

### Error: "Cannot find module 'drizzle-kit'"
```bash
bun install
```

### Error: "Database connection failed"
Make sure your `.env` has:
```
DATABASE_URL=postgresql://...
```

### Schema not updating
1. Delete `drizzle/schema.ts`
2. Run `bun drizzle-kit generate` again
3. Check that `sesMessageId` now appears in the file
